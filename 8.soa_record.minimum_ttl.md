# Task #8 - soa_record.minimum_ttl - Implementation Proof

## Summary
Implemented `soa_record.minimum_ttl` field in post-creation SOA record operation. The field maps to `properties.soaRecord.minimumTtl` in the Azure API and has a default value of 10 with validation for non-negative integers.

## Shadow Implementation
```hcl
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type                 = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
      name                 = "@"
      parent_id            = null
      tags                 = null
      ignore_null_property = true
      retry                = null
    }
    body = {
      properties = {
        soaRecord = {
          email      = var.soa_record.email
          expireTime = var.soa_record.expire_time
          minimumTtl = var.soa_record.minimum_ttl  # <-
        }
      }
    }
    locks = local.locks
  } : null
}
```

## Create Phase Verification

### Pattern Identification
Queried `resourcePrivateDnsZoneCreateUpdate` function:

```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).PrivateDns.PrivateZonesClient
	recordSetsClient := meta.(*clients.Client).PrivateDns.RecordSetsClient
	// ...
	
	// PRIMARY CREATE OPERATION
	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}

	// POST-CREATION OPERATION
	if v, ok := d.GetOk("soa_record"); ok {
		soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
		soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
		rsParameters := privatedns.RecordSet{
			Properties: &privatedns.RecordSetProperties{
				Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
				Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
				SoaRecord: soaRecord,  // <-- minimum_ttl is here
			},
		}
		
		if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
			return fmt.Errorf("creating/updating %s: %s", recordId, err)
		}
	}
	// ...
}
```

**Pattern**: Two-phase operation
- Phase 1: `client.CreateOrUpdateThenPoll` - Creates the Private DNS Zone
- Phase 2: `recordSetsClient.RecordSetsCreateOrUpdate` - Creates/updates the SOA record (if `soa_record` is provided)

**Classification**: This field belongs to Phase 2 (post-creation operation) → `local.post_creation0`

**SDK Function**: `RecordSetsCreateOrUpdate` is a CreateOrUpdate operation → correctly placed in `post_creation0`

## Assignment Path Verification

### Predicted Path
`properties.soaRecord.minimumTtl`

### Go Code Evidence - Expand Function
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
	return &privatedns.SoaRecord{
		Email:       pointer.To(input["email"].(string)),
		ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
		MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),  // <-- Field extracted
		RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
		RetryTime:   pointer.To(int64(input["retry_time"].(int))),
	}
}
```

### Go Code Evidence - Assignment Chain
```go
// Step 1: Expand to SoaRecord struct
soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)  // Returns *privatedns.SoaRecord

// Step 2: Assign to RecordSetProperties
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		SoaRecord: soaRecord,  // Assigned here
	},
}

// Step 3: Send to API via RecordSetsCreateOrUpdate
recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions)
```

**Assignment chain**:
1. `input["minimum_ttl"]` → `SoaRecord.MinimumTtl` (via expand function)
2. `SoaRecord` → `RecordSetProperties.SoaRecord` (via struct field assignment)
3. `RecordSetProperties` → `RecordSet.Properties` (via struct field assignment)
4. API serialization: `Properties.SoaRecord.MinimumTtl` → `properties.soaRecord.minimumTtl`

### Verified Path
`properties.soaRecord.minimumTtl`

### Path Comparison
✅ **MATCH**: Predicted path matches verified path.

## Provider Schema

From `resourcePrivateDnsZone()` schema definition:

```go
"soa_record": {
	Type:     pluginsdk.TypeList,
	MaxItems: 1,
	Optional: true,
	Computed: true,
	ForceNew: true,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"minimum_ttl": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      10,  // <-- Default value
				ValidateFunc: validation.IntAtLeast(0),  // <-- Validation: >= 0
			},
			// ... other fields
		},
	},
},
```

**Key Properties**:
- **Type**: `TypeInt`
- **Optional**: `true`
- **Default**: `10`
- **Validation**: `IntAtLeast(0)` - Must be >= 0

## Azure API Schema

From Azure API schema for `Microsoft.Network/privateDnsZones/SOA@2024-06-01`:

```
properties.soaRecord.minimumTtl: Number
```

**Description**: "The minimum value for this SOA record. By convention this is used to determine the negative caching duration."

## Mapping

- **Terraform field**: `soa_record.minimum_ttl` (snake_case)
- **Azure API field**: `soaRecord.minimumTtl` (camelCase)
- **Type**: `int` → `Number`

## Special Handling

### 1. Default Value
The field has `Default: 10` in the provider schema. This is already handled in `variables.tf`:

```hcl
variable "soa_record" {
  type = object({
    minimum_ttl  = optional(number, 10)  # Default applied via optional()
    // ...
  })
}
```

✅ **No additional handling needed** - default is applied at variable level using `optional(number, 10)` syntax.

### 2. Validation
The provider has `ValidateFunc: validation.IntAtLeast(0)`. This is already implemented in `variables.tf`:

```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.minimum_ttl >= 0
  )
  error_message = "The `minimum_ttl` must be at least 0."
}
```

✅ **Already implemented** - no additional work needed.

### 3. ForceNew Handling
The entire `soa_record` block has `ForceNew: true` in the schema. This is already handled at the block level in `migrate_main.tf`:

```hcl
replace_triggers_external_values = {
  soa_record = { value = var.soa_record }  # Entire block tracked
}
```

✅ **No additional handling needed** - ForceNew is tracked at the block level.

### 4. Post-Creation Operation
The field is part of the SOA record which is created/updated in a separate API call after the zone creation. This is correctly placed in `local.post_creation0`.

✅ **Correct placement** - field is in post-creation operation.

## Hidden Fields

No hidden fields detected for `minimum_ttl`. The expand function `expandPrivateDNSZoneSOARecord` directly maps the field without adding any hidden values.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Variable level**: `optional(number, 10)` means if not provided, defaults to 10
- **When `soa_record` is null**: The entire `post_creation0` is null, so this field is not sent to the API
- **When `soa_record` is provided but `minimum_ttl` is not specified**: The optional() default of 10 is used

✅ **Correct behavior**: Matches provider's default value handling.

### Edge Cases

1. **Zero value**: `minimum_ttl = 0` is valid (validation allows >= 0)
   - ✅ Validation in variables.tf correctly allows 0
   
2. **Negative values**: Should be rejected
   - ✅ Validation in variables.tf rejects negative values: `minimum_ttl >= 0`
   
3. **Very large values**: No upper limit in provider schema
   - ✅ No artificial upper limit imposed - matches provider behavior
   
4. **Type conversion**: Provider uses `int64(input["minimum_ttl"].(int))`
   - ✅ Terraform number type maps to Azure Number type correctly
   
5. **Null vs default**: When user doesn't specify, should use default 10
   - ✅ `optional(number, 10)` handles this correctly

### Idempotency
The field value is directly assigned without any transformation or ordering:
```hcl
minimumTtl = var.soa_record.minimum_ttl
```
✅ **Idempotent**: Same input always produces same output.

### Safe References
The field is only accessed when `var.soa_record != null`:
```hcl
post_creation0 = var.soa_record != null ? { ... } : null
```
✅ **Safe**: Null check at block level protects all nested field accesses.

## Checklist

- ✅ Property in correct local (`post_creation0` for post-creation operation)
- ✅ Default value replicated in variables.tf via `optional(number, 10)`
- ✅ Validation replicated in variables.tf (`minimum_ttl >= 0`)
- ✅ No ForceNew wrapping needed (handled at block level)
- ✅ Hidden fields checked (none found)
- ✅ Critical review completed (null, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis section included
- ✅ Assignment path traced through all struct assignments
- ✅ Create phase pattern verified (two-phase, post-creation operation)
- ✅ Logic EXACTLY replicated from provider (no shortcuts or alternatives)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #8 - soa_record.minimum_ttl

### Validation Results

✅ **Field Location & Phase Detection:** Correctly placed in `local.post_creation0` for post-creation SOA record operation (RecordSetsCreateOrUpdate after primary zone creation)
✅ **Assignment Path Verification:** Complete trace documented - input["minimum_ttl"] → SoaRecord.MinimumTtl → RecordSetProperties.SoaRecord → properties.soaRecord.minimumTtl
✅ **Default Value Implementation:** `optional(number, 10)` in variables.tf correctly implements provider's `Default: 10` using preferred method
✅ **Validation Implementation:** `minimum_ttl >= 0` validation in variables.tf exactly replicates provider's `IntAtLeast(0)` 
✅ **ForceNew Handling:** Block-level tracking via `soa_record = { value = var.soa_record }` correctly tracks full value changes (not just presence)
✅ **Type Conversion:** Direct assignment from Terraform number to Azure Number - correct, no unnecessary conversions
✅ **Null Handling:** Safe reference - field access protected by block-level null check `var.soa_record != null`
✅ **Edge Case Analysis:** Comprehensive coverage of zero values, negatives, type conversion, null vs default, idempotency
✅ **Deferred Work Completion:** No following.md exists - no deferred work to complete
✅ **Code Quality:** Clean implementation with direct assignment, no JSON encoding issues, AzAPI 2.0+ native objects used correctly

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The implementation:
- Uses the correct phase (post-creation operation) with proper SDK function classification
- Implements default value using preferred optional() syntax in object type
- Replicates validation exactly from provider schema
- Traces complete assignment path through all struct layers
- Handles all edge cases correctly with comprehensive analysis
- Follows stable keys requirement for ForceNew tracking at block level
- Uses safe null checking patterns

**Status:** APPROVED ✅

---
