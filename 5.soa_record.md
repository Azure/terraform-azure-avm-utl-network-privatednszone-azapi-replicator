# Task #5 - soa_record Block - STRUCTURE SKELETON

## Summary
Created structure skeleton for `soa_record` block with conditional post-creation operation. The block is ForceNew and triggers a separate SOA record API call after zone creation. All individual arguments (Tasks #6-12) are marked as placeholders.

## Shadow Implementation
```hcl
locals {
  replace_triggers_external_values = {
    soa_record = { value = var.soa_record }  # <-
  }
  
  # Post-creation operation for SOA record (separate API call after zone creation)
  post_creation0 = var.soa_record != null ? {  # <-
    azapi_header = {  # <-
      type                 = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"  # <-
      name                 = "@"  # <-
      parent_id            = null  # <-
      tags                 = null  # <-
      ignore_null_property = true  # <-
      retry                = null  # <-
    }
    body = {  # <-
      properties = {  # <-
        # ttl = ... # Task #11  # <-
        # metadata = ... # Task #12  # <-
        soaRecord = {  # <-
          # email = ... # Task #6  # <-
          # expireTime = ... # Task #7  # <-
          # minimumTtl = ... # Task #8  # <-
          # refreshTime = ... # Task #9  # <-
          # retryTime = ... # Task #10  # <-
        }
      }
    }
    locks = local.locks  # <-
  } : null  # <-
  
  post_creation0_sensitive_body = null  # <-
}
```

## Create Phase Verification

### Query Evidence
From `resourcePrivateDnsZoneCreateUpdate` (create method):

```go
// Primary zone creation
if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
	return fmt.Errorf("creating/updating %s: %s", id, err)
}

// Post-creation SOA record operation
if v, ok := d.GetOk("soa_record"); ok {
	soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
	soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
	rsParameters := privatedns.RecordSet{
		Properties: &privatedns.RecordSetProperties{
			Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
			Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
			SoaRecord: soaRecord,
		},
	}

	recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

	if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
		return fmt.Errorf("creating/updating %s: %s", recordId, err)
	}
}
```

### Pattern Identification
**Pattern:** Two-phase creation
1. **Phase 1 (Primary):** `client.CreateOrUpdateThenPoll()` - Creates the Private DNS Zone
2. **Phase 2 (Post-Creation):** `recordSetsClient.RecordSetsCreateOrUpdate()` - Creates/updates SOA record with RecordType=SOA, name="@"

### SDK Function Classification
- **Phase 1:** `PrivateZonesClient.CreateOrUpdateThenPoll` (primary zone creation)
- **Phase 2:** `RecordSetsClient.RecordSetsCreateOrUpdate` (SOA record creation) → **CreateOrUpdate** type → `post_creation0`

### Field Assignment Decision
The `soa_record` block is processed **AFTER** the primary zone creation in a **separate API call**. This maps to:
- **Local:** `post_creation0` (first post-creation operation using CreateOrUpdate)
- **Type:** Post-creation child resource (different resource type: SOA record set)
- **Conditional:** Only executed when `var.soa_record != null`

## Assignment Path Verification

### Predicted Path
For SOA record in Azure API:
- Resource Type: `Microsoft.Network/privateDnsZones/SOA`
- Body structure: `properties.soaRecord` for SOA fields, `properties.ttl` for TTL, `properties.metadata` for tags

### Go Code Evidence
```go
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
		Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
		SoaRecord: soaRecord,  // soaRecord is *privatedns.SoaRecord
	},
}
```

Tracing the assignment:
1. `rsParameters` is type `privatedns.RecordSet`
2. `.Properties` is assigned `&privatedns.RecordSetProperties` (adds `properties` nesting)
3. Within Properties:
   - `.Ttl` → maps to `properties.ttl`
   - `.Metadata` → maps to `properties.metadata`
   - `.SoaRecord` → maps to `properties.soaRecord`

### Verified Path
- `ttl` → `body.properties.ttl`
- `tags` → `body.properties.metadata`
- SOA fields (email, expireTime, etc.) → `body.properties.soaRecord.{field}`

### Path Comparison
✅ **MATCH** - Predicted path matches verified path.

## Provider Schema

### Schema Definition
```go
"soa_record": {
	Type:     pluginsdk.TypeList,
	MaxItems: 1,
	Optional: true,
	Computed: true,
	ForceNew: true,  // ← Forces new resource when changed
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"email": {
				Type:         pluginsdk.TypeString,
				Required:     true,
				ValidateFunc: validate.PrivateDnsZoneSOARecordEmail,
			},
			"expire_time": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      2419200,
				ValidateFunc: validation.IntAtLeast(0),
			},
			"minimum_ttl": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      10,
				ValidateFunc: validation.IntAtLeast(0),
			},
			"refresh_time": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      3600,
				ValidateFunc: validation.IntAtLeast(0),
			},
			"retry_time": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      300,
				ValidateFunc: validation.IntAtLeast(0),
			},
			"ttl": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      3600,
				ValidateFunc: validation.IntBetween(0, math.MaxInt32),
			},
			"tags": commonschema.Tags(),
			// Computed fields: fqdn, host_name, serial_number (not migrated)
		},
	},
}
```

### Block Properties
- **Type:** List with MaxItems: 1 (optional single block)
- **Required:** No (Optional)
- **ForceNew:** Yes - entire block triggers replacement
- **Default:** None (block is optional)
- **Computed:** Yes (but can be explicitly configured)

## Azure API Schema

### Query Result
```
Microsoft.Network/privateDnsZones/SOA@2024-06-01
body.properties.soaRecord: {
  email: String (required)
  expireTime: Number (required)
  host: String (required)
  minimumTtl: Number (required)
  refreshTime: Number (required)
  retryTime: Number (required)
  serialNumber: Number (required)
}
body.properties.ttl: Number
body.properties.metadata: Map(String)
```

### Azure API Notes
- The SOA record is a separate child resource with type `Microsoft.Network/privateDnsZones/SOA`
- Record name is always `"@"` (represents zone apex)
- The `host` and `serialNumber` fields are computed/managed by Azure (not in our schema)

## Hidden Fields Check

### Expand Function Analysis
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
	return &privatedns.SoaRecord{
		Email:       pointer.To(input["email"].(string)),
		ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
		MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
		RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
		RetryTime:   pointer.To(int64(input["retry_time"].(int))),
	}
}
```

### Hidden Fields Result
✅ **NO HIDDEN FIELDS** - The expand function only uses schema-defined fields. No hardcoded values or additional fields are added.

**Note:** The `host` and `serialNumber` fields in Azure API are computed values managed by Azure, not set by the provider.

## Mapping

### Terraform to Azure API
- Block: `soa_record` → Resource: `Microsoft.Network/privateDnsZones/SOA`
- Block presence → Conditional `post_creation0` operation
- Record name: `"@"` (hardcoded, represents zone apex)

### Field Mapping (Delegated to Child Tasks)
Individual field mappings are delegated to Tasks #6-12:
- Task #6: `email` → `properties.soaRecord.email`
- Task #7: `expire_time` → `properties.soaRecord.expireTime`
- Task #8: `minimum_ttl` → `properties.soaRecord.minimumTtl`
- Task #9: `refresh_time` → `properties.soaRecord.refreshTime`
- Task #10: `retry_time` → `properties.soaRecord.retryTime`
- Task #11: `ttl` → `properties.ttl`
- Task #12: `tags` → `properties.metadata`

## Special Handling

### 1. ForceNew Behavior
**Schema:** `ForceNew: true` on the entire block

**Implementation:**
```hcl
replace_triggers_external_values = {
  soa_record = { value = var.soa_record }
}
```

**Rationale:**
- Tracks the **FULL value** of the entire `soa_record` object
- Detects: `null` → `{...}`, `{...}` → `null`, AND internal field changes like `{email="old"}` → `{email="new"}`
- Using `{ value = var.soa_record }` ensures the key is always present for stability
- Critical: We track the full object value, not just presence, to catch all internal changes

### 2. Post-Creation Operation
**Pattern:** Separate API call after primary zone creation

**Implementation:**
```hcl
post_creation0 = var.soa_record != null ? {
  azapi_header = {
    type = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
    name = "@"
    parent_id = null  # Set by root module
  }
  body = { properties = { ... } }
  locks = local.locks
} : null
```

**Type Classification:**
- SDK Function: `RecordSetsCreateOrUpdate` → **CreateOrUpdate type** → `post_creation0`
- Index: 0 (first post-creation operation)
- This is a **child resource** creation, not an update to the main zone

### 3. Conditional Execution
**Logic:** SOA record operation only executes when `var.soa_record != null`

**Provider Evidence:**
```go
if v, ok := d.GetOk("soa_record"); ok {
	// SOA record creation logic
}
```

**Implementation:** The entire `post_creation0` local is conditionally set to `null` when the block is not provided.

### 4. Resource Naming
**Azure Resource:** The SOA record name is always `"@"` (zone apex)

**Provider Evidence:**
```go
recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")
```

**Implementation:** Hardcoded `name = "@"` in `post_creation0.azapi_header`

## Deferred Work Completion
Not applicable - no work was deferred to this task in `following.md` (file does not exist yet).

## Edge Case Analysis

### Null Semantics
- **`var.soa_record = null`:** No SOA record modification, `post_creation0 = null`, zone inherits default SOA record from Azure
- **Meaning:** "Use Azure default SOA record"
- **Implementation:** Conditional check prevents post-creation operation entirely

### Block to Null Transition
- **Current state:** SOA record exists with custom values
- **New state:** `var.soa_record = null`
- **Behavior:** `ForceNew: true` → Triggers replacement → New zone created without custom SOA → Azure default SOA applies
- **Correct:** Matches provider behavior exactly

### Null to Block Transition
- **Current state:** Zone with default SOA
- **New state:** `var.soa_record = { email = "admin.example.com", ... }`
- **Behavior:** `ForceNew: true` → Triggers replacement → New zone created → SOA record set in `post_creation0`
- **Correct:** Matches provider behavior exactly

### Internal Field Changes
- **Current:** `{ email = "old@example.com", ttl = 3600 }`
- **New:** `{ email = "new@example.com", ttl = 3600 }`
- **Detection:** `replace_triggers_external_values.soa_record` tracks full object value → Change detected
- **Behavior:** ForceNew triggered → Zone rebuilt with new SOA record
- **Correct:** Matches provider behavior (block is ForceNew)

### Empty String vs Null
- **`email = ""`:** Invalid - provider validation will catch this (Task #6 responsibility)
- **`email = null`:** Invalid - `email` is Required in the object type definition
- **Type System:** Terraform prevents `null` for required fields

### Boundary Conditions
- **Defaults:** All optional numeric fields have defaults applied via `optional(type, default)` in `variables.tf`
- **Zero values:** TTL=0, expire_time=0 are valid per validation (`IntAtLeast(0)`)
- **Maximum:** TTL max is `math.MaxInt32` (2147483647) - validated in variables.tf

### Idempotency
- **Same input:** `post_creation0` generates identical structure → Azure API recognizes no change
- **Object stability:** All keys in `post_creation0` are statically present when block exists
- **Conditional stability:** Block presence is tracked in ForceNew trigger

### Safe References
- **`var.soa_record != null` check:** Protects all nested accesses in `post_creation0`
- **Optional fields:** Handled by `optional(type, default)` in variable definition
- **No unsafe dereferencing:** All field accesses happen within the conditional block

### Azure API Default SOA Record
- **Scenario:** User doesn't provide `soa_record` block
- **Provider behavior:** No SOA record API call, zone created with Azure default SOA
- **Our implementation:** `post_creation0 = null` → No post-creation operation
- **Result:** ✅ EXACT match - user gets Azure default SOA

## Child Tasks Ready for Delegation

Based on the skeleton structure created, the following child tasks are now **READY** for delegation:

| Task # | Field | Type | Parent Block | Status |
|--------|-------|------|--------------|--------|
| 6 | soa_record.email | Argument | soa_record | Ready |
| 7 | soa_record.expire_time | Argument | soa_record | Ready |
| 8 | soa_record.minimum_ttl | Argument | soa_record | Ready |
| 9 | soa_record.refresh_time | Argument | soa_record | Ready |
| 10 | soa_record.retry_time | Argument | soa_record | Ready |
| 11 | soa_record.ttl | Argument | soa_record | Ready |
| 12 | soa_record.tags | Argument | soa_record | Ready |

**Total:** 7 child tasks ready for delegation.

## Checklist

- ✅ Block skeleton created with conditional structure
- ✅ ForceNew tracking implemented: `{ value = var.soa_record }`
- ✅ Post-creation operation identified and structured as `post_creation0`
- ✅ All child arguments marked with task number placeholders
- ✅ Hidden fields checked in expand function (none found)
- ✅ Assignment path verified through Go code tracing
- ✅ Azure API schema queried and verified
- ✅ Resource type correctly identified: `Microsoft.Network/privateDnsZones/SOA@2024-06-01`
- ✅ Record name hardcoded as `"@"` (zone apex)
- ✅ Conditional execution logic matches provider
- ✅ Edge cases analyzed (null semantics, transitions, boundaries)
- ✅ Idempotency verified
- ✅ Safe references ensured
- ✅ Child tasks identified and ready for delegation
- ✅ Proof document created
- ✅ track.md ready for status update

## Implementation Files

### Created Files
1. `migrate_main.tf` - Contains `post_creation0` structure with placeholders
2. `migrate_outputs.tf` - Contains output for `post_creation0` and `post_creation0_sensitive_body`
3. `migrate_validation.tf` - Placeholder for future runtime validations
4. `migrate_variables.tf` - Placeholder for new variables (none needed for skeleton)

### Modified Files
None - all files are new creations for this migration.

## Notes

1. **Post-Creation Pattern:** This is the first (and only) post-creation operation for this resource, hence `post_creation0`
2. **No Sensitive Fields:** The SOA record has no sensitive/writeonly fields, so `post_creation0_sensitive_body = null`
3. **Child Resource Type:** The SOA record is a child resource type, not an update to the main zone
4. **Validation Location:** All SOA record validations are already in `variables.tf` (from previous tasks), no additional validations needed for skeleton
5. **Lock Detection:** Locks will be handled by the `__check_root_hidden_fields__` task (Task #4) which is marked as completed

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #5 - soa_record

### Validation Results

✅ **ForceNew Logic:** Mode 1 (Direct Value Tracking) - Correctly wraps full object value in `{ value = var.soa_record }` to detect all changes including internal field modifications
✅ **Stable Keys:** Key `soa_record` is always present in `replace_triggers_external_values` map
✅ **Phase Detection:** Correctly identified as post-creation operation (`post_creation0`) - separate CreateOrUpdate API call after primary zone creation
✅ **Type Conversion:** Not applicable (skeleton structure)
✅ **Null Handling:** Correctly uses conditional `var.soa_record != null ? {...} : null` to match provider behavior
✅ **Post-Creation Classification:** Correctly identified SDK function `RecordSetsCreateOrUpdate` as CreateOrUpdate type → `post_creation0` (first post-creation operation)
✅ **Resource Type:** Correctly specified as `Microsoft.Network/privateDnsZones/SOA@2024-06-01`
✅ **Record Name:** Correctly hardcoded as `"@"` (zone apex) matching provider evidence
✅ **Outputs:** Both `post_creation0` and `post_creation0_sensitive_body` properly created with correct attributes
✅ **Locks Reference:** Included `locks = local.locks` in post_creation0 structure
✅ **Validations:** Not applicable for skeleton - validations handled by child tasks (#6-12)
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made (skeleton task)
✅ **Edge Cases:** Comprehensive analysis covering null semantics, transitions, boundaries, idempotency, and safe references

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The skeleton structure correctly:
- Tracks the FULL value of `soa_record` to detect all changes (not just presence)
- Classifies the operation as `post_creation0` based on SDK function type (CreateOrUpdate)
- Uses conditional logic matching provider's `if v, ok := d.GetOk("soa_record")` pattern
- Provides stable placeholder structure for child tasks (#6-12)
- No deviations, simplifications, or "safer alternatives" were found

**Status:** APPROVED ✅

---
