# Task #6: soa_record.email - Proof Document

## Summary
Implemented the `soa_record.email` block argument for azurerm_private_dns_zone. The field is Required within the soa_record block and maps to `post_creation0.body.properties.soaRecord.email` in the SOA record creation operation.

## Shadow Implementation
```hcl
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type                 = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
      name                 = "@"
      parent_id            = null # Will be set by root module to azapi_resource.this.id
      tags                 = null
      ignore_null_property = true
      retry                = null
    }
    body = {
      properties = {
        # ttl = ... # Task #11
        # metadata = ... # Task #12
        soaRecord = {
          email = var.soa_record.email # <-
          # expireTime = ... # Task #7
          # minimumTtl = ... # Task #8
          # refreshTime = ... # Task #9
          # retryTime = ... # Task #10
        }
      }
    }
    locks = local.locks
  } : null
}
```

## Create Phase Verification

### Query: Create Method
```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).PrivateDns.PrivateZonesClient
	recordSetsClient := meta.(*clients.Client).PrivateDns.RecordSetsClient
	subscriptionId := meta.(*clients.Client).Account.SubscriptionId
	ctx, cancel := timeouts.ForCreateUpdate(meta.(*clients.Client).StopContext, d)
	defer cancel()

	id := privatezones.NewPrivateDnsZoneID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))
	// ... resource existence check ...

	parameters := privatezones.PrivateZone{
		Location: pointer.To("global"),
		Tags:     tags.Expand(d.Get("tags").(map[string]interface{})),
	}

	options := privatezones.CreateOrUpdateOperationOptions{
		IfMatch:     pointer.To(""),
		IfNoneMatch: pointer.To(""),
	}

	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}

	// AFTER primary create - this is the SOA record creation
	if v, ok := d.GetOk("soa_record"); ok {
		soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
		soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
		rsParameters := privatedns.RecordSet{
			Properties: &privatedns.RecordSetProperties{
				Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
				Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
				SoaRecord: soaRecord,
			},
		}

		recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

		val := fmt.Sprintf("%s%s", id.PrivateDnsZoneName, strings.TrimSuffix(*soaRecord.Email, "."))
		if len(val) > 253 {
			return fmt.Errorf("the value %q for `email` which is concatenated with Private DNS Zone `name` cannot exceed 253 characters excluding a trailing period", val)
		}

		createOptions := privatedns.RecordSetsCreateOrUpdateOperationOptions{
			IfMatch:     pointer.To(""),
			IfNoneMatch: pointer.To(""),
		}

		if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
			return fmt.Errorf("creating/updating %s: %s", recordId, err)
		}
	}
	// ...
}
```

### Pattern Identification
**Two-Phase Creation Pattern:**
1. **Primary Create:** `client.CreateOrUpdateThenPoll(ctx, id, parameters, options)` - creates the Private DNS Zone
2. **Post-Creation:** `recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions)` - creates the SOA record

### Field Classification
The `soa_record` fields (including `email`) are processed **AFTER** the primary Private DNS Zone creation, in a separate API call to create/update the SOA record set. This is a **post-creation operation**.

### Decision
The `email` field belongs in `post_creation0.body.properties.soaRecord.email` as documented in Task #5.

## Assignment Path Verification

### Predicted Path
`post_creation0.body.properties.soaRecord.email`

### Go Code Evidence - Expand Function
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
	return &privatedns.SoaRecord{
		Email:       pointer.To(input["email"].(string)),
		ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
		MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
		RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
		RetryTime:   pointer.To(int64(input["retry_time"].(int))),
	}
}
```

### Go Code Evidence - Assignment Path
From Create method:
```go
soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
		Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
		SoaRecord: soaRecord,  // <- Assigned here
	},
}
```

**Struct Assignment Tracing:**
1. `input["email"].(string)` → `SoaRecord.Email` (in expand function)
2. `soaRecord` → `RecordSetProperties.SoaRecord` (in Create method)
3. `&privatedns.RecordSetProperties{...}` → `RecordSet.Properties`

### Verified Path
`body.properties.soaRecord.email` (where `body` is the RecordSet resource)

### Path Comparison
- **Predicted:** `post_creation0.body.properties.soaRecord.email`
- **Verified:** `body.properties.soaRecord.email`
- **Match:** ✅ EXACT MATCH

## Provider Schema

### Source: azurerm_private_dns_zone
```go
"soa_record": {
	Type:     pluginsdk.TypeList,
	MaxItems: 1,
	Optional: true,
	Computed: true,
	ForceNew: true,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"email": {
				Type:         pluginsdk.TypeString,
				Required:     true,
				ValidateFunc: validate.PrivateDnsZoneSOARecordEmail,
			},
			// ... other fields ...
		},
	},
},
```

### Key Properties
- **Type:** String
- **Required:** Yes (within soa_record block)
- **ForceNew:** Yes (parent block is ForceNew)
- **Validation:** `validate.PrivateDnsZoneSOARecordEmail`
- **Default:** None
- **Sensitive:** No

## Azure API Schema

### Resource Type
`Microsoft.Network/privateDnsZones/SOA@2024-06-01`

### Property Path
`body.properties.soaRecord.email`

### Type Information
```
ObjectWithOptionalAttrs(map[string]Type{
    "email": String,
    "expireTime": Number,
    "host": String,
    "minimumTtl": Number,
    "refreshTime": Number,
    "retryTime": Number,
    "serialNumber": Number
}, []string{"email", "expireTime", "host", "minimumTtl", "refreshTime", "retryTime", "serialNumber"})
```

### Azure API Documentation
"The email contact for this SOA record."

## Hidden Fields
✅ **NO HIDDEN FIELDS** - The expand function directly maps the email field without adding hidden fields.

## Mapping

### snake_case to camelCase
- Terraform: `email`
- Azure API: `email` (no transformation needed - already lowercase)

## Special Handling

### Validation
The field has custom validation implemented in `variables.tf`:

```hcl
validation {
  condition = var.soa_record == null || (
    length(var.soa_record.email) > 0 &&
    length(split(".", var.soa_record.email)) >= 2 &&
    length(split(".", var.soa_record.email)) <= 34 &&
    alltrue([for segment in split(".", var.soa_record.email) : segment != ""]) &&
    alltrue([for segment in split(".", var.soa_record.email) : length(segment) <= 63]) &&
    can(regex("^[a-zA-Z0-9._-]+$", var.soa_record.email))
  )
  error_message = "The `email` must be a valid format: non-empty, between 2 and 34 dot-separated segments, each segment 1-63 characters, no consecutive periods, and only containing letters, numbers, underscores, dashes, and periods."
}
validation {
  condition = var.soa_record == null || (
    length(format("%s%s", var.name, trimsuffix(var.soa_record.email, "."))) <= 253
  )
  error_message = "The value for `email` which is concatenated with Private DNS Zone `name` cannot exceed 253 characters excluding a trailing period."
}
```

This exactly replicates the provider's validation logic, including the cross-field validation with `name`.

### ForceNew Handling
The parent block `soa_record` is marked as `ForceNew: true` in the provider schema. This is already handled in Task #5, where the entire `soa_record` variable is tracked in `replace_triggers_external_values`:

```hcl
replace_triggers_external_values = {
  soa_record = { value = var.soa_record }
}
```

No additional ForceNew handling is needed for this field.

### Sensitive Fields
✅ **NOT SENSITIVE** - The email field is not marked as Sensitive in the provider schema.

### Post-Creation Operation
✅ **Post-Creation Field** - This field is part of the `post_creation0` operation as identified in Task #5. The SOA record is created/updated AFTER the primary Private DNS Zone creation.

## Deferred Work Completion
Checked `following.md` - no deferred work for Task #6.

## Critical Review & Edge Case Analysis

### Null Semantics
- **When `var.soa_record == null`:** The entire `post_creation0` block is `null`, so no SOA record update occurs
- **When `var.soa_record != null`:** The `email` field is Required, so it must be provided (enforced by variable definition)
- **Meaning:** Email cannot be null when soa_record is set (Required field)

### Edge Cases

**Empty String:**
✅ Blocked by validation - minimum length is 2 segments, each non-empty

**Special Characters:**
✅ Blocked by validation - only alphanumeric, dots, underscores, and dashes allowed

**Length Limits:**
✅ Enforced by validation:
- Segment count: 2-34 segments
- Segment length: 1-63 characters per segment
- Combined length with zone name: ≤253 characters (excluding trailing period)

**Trailing Period:**
✅ Handled by provider - uses `strings.TrimSuffix(*soaRecord.Email, ".")` in validation

### Idempotency
✅ **IDEMPOTENT** - Direct string value assignment, no ordering or transformation issues

### Safe References
✅ **SAFE** - Field is accessed via `var.soa_record.email` only when `var.soa_record != null` is already checked in the conditional

### Runtime Validation
The provider performs an additional runtime validation in the Create method:
```go
val := fmt.Sprintf("%s%s", id.PrivateDnsZoneName, strings.TrimSuffix(*soaRecord.Email, "."))
if len(val) > 253 {
	return fmt.Errorf("the value %q for `email` which is concatenated with Private DNS Zone `name` cannot exceed 253 characters excluding a trailing period", val)
}
```

This is replicated in `variables.tf` validation block, ensuring plan-time failure instead of apply-time failure.

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.email`)
- ✅ ForceNew wrapped (parent block tracked: `soa_record = { value = var.soa_record }`)
- ✅ ALL logic EXACTLY replicated from provider (direct string mapping)
- ✅ Validations IMPLEMENTED in variables.tf (MANDATORY - format, length, cross-field with name)
- ✅ TODO comment N/A (not a sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md (N/A - no deferral needed)
- ✅ Deferred work from following.md (none found for Task #6)
- ✅ Critical review (null, edge, idempotent, safe refs) completed
- ✅ Edge Case Analysis in proof (included above)
- ✅ Proof created
- ✅ track.md to be updated to Pending for check
- ✅ Self-Review: Only implementing soa_record.email field as specified in Task #6

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #6 - soa_record.email

### Validation Results

✅ **ForceNew Logic:** Parent block `soa_record` is ForceNew, correctly tracked in Task #5 with full value tracking (not presence-only). Child field inherits ForceNew behavior. No additional tracking needed.

✅ **Stable Keys:** Key `soa_record` always present in `replace_triggers_external_values` using stable `{ value = var.soa_record }` pattern.

✅ **Phase Detection:** Field correctly placed in `post_creation0.body.properties.soaRecord.email`. Evidence from Go code confirms SOA record is created via separate `RecordSetsCreateOrUpdate` call AFTER primary zone creation.

✅ **Type Conversion:** Correct direct mapping from Terraform string to Azure API string. No conversion needed.

✅ **Null Handling:** Correctly propagates null semantics. When `var.soa_record == null`, entire `post_creation0` is null. Field is Required within block, enforced by variable type.

✅ **Validations:** ALL provider validations EXACTLY replicated in `variables.tf`:
  - Empty string check (length > 0)
  - Segment count validation (2-34 segments)
  - No consecutive periods (all segments non-empty)
  - Segment length validation (each ≤ 63 characters)
  - Character validation (regex `^[a-zA-Z0-9._-]+$`)
  - Cross-field validation with zone name (combined length ≤ 253, excluding trailing period)

✅ **Assignment Path Verification:** Predicted path `post_creation0.body.properties.soaRecord.email` matches verified path from Go code. All struct assignments traced: `input["email"]` → `SoaRecord.Email` → `RecordSetProperties.SoaRecord` → `RecordSet.Properties`.

✅ **Deferred Work Completion:** No `following.md` file exists. No deferred work for this task.

✅ **Deferred Work Recording:** No deferrals made to other tasks.

✅ **Edge Cases:** All edge cases properly analyzed and handled:
  - Empty string: Blocked by validation
  - Special characters: Validated by regex pattern
  - Length limits: All three constraints enforced (segment count, per-segment length, combined with zone name)
  - Trailing period: Handled by `trimsuffix()` in cross-field validation
  - Consecutive periods: Blocked by segment emptiness check
  - Null safety: Field accessed only when parent block is non-null

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The validation logic from `validate.PrivateDnsZoneSOARecordEmail` has been replicated line-by-line in Terraform validation blocks. The cross-field validation from the Create method (email concatenated with zone name ≤ 253 characters) is also correctly implemented. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
