# Task #10: soa_record.retry_time

## Summary
Implemented `soa_record.retry_time` as an optional nested block argument that maps to Azure API field `properties.soaRecord.retryTime` in the post-creation SOA record update operation, with default value of 300 and validation requiring value >= 0.

## Shadow Implementation
```hcl
# In migrate_main.tf
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type                 = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
      name                 = "@"
      parent_id            = null
      tags                 = null
      ignore_null_property = true
      retry                = null
    }
    body = {
      properties = {
        soaRecord = {
          email       = var.soa_record.email
          expireTime  = var.soa_record.expire_time
          minimumTtl  = var.soa_record.minimum_ttl
          refreshTime = var.soa_record.refresh_time
          retryTime   = var.soa_record.retry_time # <-
        }
      }
    }
    locks = local.locks
  } : null
}
```

```hcl
# In variables.tf (already exists, no modification needed)
variable "soa_record" {
  type = object({
    email        = string
    expire_time  = optional(number, 2419200)
    minimum_ttl  = optional(number, 10)
    refresh_time = optional(number, 3600)
    retry_time   = optional(number, 300) # <-
    tags         = optional(map(string))
    ttl          = optional(number, 3600)
  })
  default     = null
  description = <<-EOT
 - `email` - (Required) The email contact for the SOA record.
 - `expire_time` - (Optional) The expire time for the SOA record. Defaults to `2419200`.
 - `minimum_ttl` - (Optional) The minimum Time To Live for the SOA record. By convention, it is used to determine the negative caching duration. Defaults to `10`.
 - `refresh_time` - (Optional) The refresh time for the SOA record. Defaults to `3600`.
 - `retry_time` - (Optional) The retry time for the SOA record. Defaults to `300`. # <-
 - `tags` - (Optional) A mapping of tags to assign to the Record Set.
 - `ttl` - (Optional) The Time To Live of the SOA Record in seconds. Defaults to `3600`.
EOT

  validation { # <-
    condition = var.soa_record == null || ( # <-
      var.soa_record.retry_time >= 0 # <-
    ) # <-
    error_message = "The `retry_time` must be at least 0." # <-
  } # <-
}
```

## Create Phase Verification

### Query Result
From `resourcePrivateDnsZoneCreateUpdate` function:

```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).PrivateDns.PrivateZonesClient
	recordSetsClient := meta.(*clients.Client).PrivateDns.RecordSetsClient
	// ...
	
	// PRIMARY CREATE: Creates the Private DNS Zone
	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}

	// POST-CREATION OPERATION: Updates the SOA record
	if v, ok := d.GetOk("soa_record"); ok {
		soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
		soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
		rsParameters := privatedns.RecordSet{
			Properties: &privatedns.RecordSetProperties{
				Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
				Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
				SoaRecord: soaRecord,
			},
		}

		recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")
		// ...
		if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
			return fmt.Errorf("creating/updating %s: %s", recordId, err)
		}
	}
	// ...
}
```

### Pattern Analysis
This is a **two-phase operation**:
1. **Primary Create**: `client.CreateOrUpdateThenPoll()` creates the Private DNS Zone
2. **Post-Creation Operation** (index 0): `recordSetsClient.RecordSetsCreateOrUpdate()` updates the SOA record

The SOA record fields (including `retry_time`) are processed in the second phase.

### SDK Function Classification
- **SDK Function**: `RecordSetsCreateOrUpdate` (wraps CreateOrUpdate operation)
- **Classification**: CreateOrUpdate → `post_creation0`
- **Index**: 0 (first post-operation)

### Field Classification Decision
The `retry_time` field is part of the SOA record configuration passed to `recordSetsClient.RecordSetsCreateOrUpdate()`, which is a post-creation operation. Therefore, it belongs in `local.post_creation0.body.properties.soaRecord.retryTime`.

## Assignment Path Verification

### Predicted Path
`properties.soaRecord.retryTime`

### Go Code Evidence
From `expandPrivateDNSZoneSOARecord` function:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
	return &privatedns.SoaRecord{
		Email:       pointer.To(input["email"].(string)),
		ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
		MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
		RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
		RetryTime:   pointer.To(int64(input["retry_time"].(int))),
	}
}
```

From Create function assignment:
```go
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
		Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
		SoaRecord: soaRecord,  // <- Assigns the expanded SOA record here
	},
}
```

### Struct Assignment Trace
1. `input["retry_time"]` → `SoaRecord.RetryTime` (via `expandPrivateDNSZoneSOARecord`)
2. `SoaRecord` → `RecordSetProperties.SoaRecord` (via `rsParameters`)
3. `RecordSetProperties` → `RecordSet.Properties` (via `rsParameters`)

### Verified Path
`properties.soaRecord.retryTime`

### Path Comparison
✅ **MATCH** - Predicted path matches the verified Go code assignment path.

## Provider Schema

From schema query:
```go
"retry_time": {
	Type:         pluginsdk.TypeInt,
	Optional:     true,
	Default:      300,
	ValidateFunc: validation.IntAtLeast(0),
},
```

**Key Properties**:
- **Type**: Int
- **Optional**: true
- **Default**: 300
- **Validation**: IntAtLeast(0) - value must be >= 0
- **ForceNew**: Inherited from parent `soa_record` block (true)

## Azure API Schema

### Query Result
From `query_azapi_resource_schema` for `Microsoft.Network/privateDnsZones/SOA@2024-06-01`:
```
soaRecord:ObjectWithOptionalAttrs(map[string]Type{
  "email":String, 
  "expireTime":Number, 
  "host":String, 
  "minimumTtl":Number, 
  "refreshTime":Number, 
  "retryTime":Number,  // <- Our field
  "serialNumber":Number
}, ...)
```

From `query_azapi_resource_document`:
```
"The retry time for this SOA record."
```

**Azure API Property Path**: `body.properties.soaRecord.retryTime`
**Type**: Number

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Transform |
|-------------------------|----------------------|-----------|
| `retry_time` | `retryTime` | Direct integer value |

## Special Handling

### 1. Default Value
- **Provider Default**: 300
- **Implementation**: Using `optional(number, 300)` in object type definition in `variables.tf`
- **Behavior**: When `retry_time` is not specified, Terraform automatically uses 300

### 2. Validation
- **Provider Validation**: `validation.IntAtLeast(0)` - requires value >= 0
- **Implementation**: Added validation block in `variables.tf`:
  ```hcl
  validation {
    condition = var.soa_record == null || (
      var.soa_record.retry_time >= 0
    )
    error_message = "The `retry_time` must be at least 0."
  }
  ```
- **Exact Match**: ✅ Replicates provider's IntAtLeast(0) constraint exactly

### 3. ForceNew Behavior
- **Schema**: Parent `soa_record` block has `ForceNew: true`
- **Implementation**: Already handled in Task #5 - `soa_record` is in `replace_triggers_external_values`:
  ```hcl
  replace_triggers_external_values = {
    soa_record = { value = var.soa_record }
  }
  ```
- **Effect**: Any change to `retry_time` (or any field in `soa_record`) triggers resource replacement

### 4. Post-Creation Operation
- **Phase**: Post-creation (not part of main zone creation)
- **Location**: `local.post_creation0.body.properties.soaRecord.retryTime`
- **Type**: CreateOrUpdate operation for SOA record type
- **Parent**: Requires zone to exist first, then updates SOA record

## Hidden Fields
None. This is a straightforward field mapping with no hidden or computed fields.

## Deferred Work Completion
Checked `following.md` - no work deferred to Task #10. No deferred work to complete.

## Edge Case Analysis

### Null Semantics
- **When `var.soa_record = null`**: Entire `post_creation0` local is `null`, no SOA record update occurs
- **When `var.soa_record != null` but `retry_time` not specified**: Uses default value 300 via `optional(number, 300)`
- **Meaning**: Null means "don't update SOA record", omitted means "use default"

### Boundary Conditions
- **Minimum Value**: 0 (validated, represents no retry)
- **Maximum Value**: Not explicitly limited in provider schema, but constrained by Azure API's integer type (int64)
- **Default Value**: 300 seconds (5 minutes)

### Idempotency
- ✅ Value directly assigned from variable without transformation
- ✅ No order-dependent operations
- ✅ Repeated applies with same value produce same result

### Safe References
- ✅ Parent null check: `var.soa_record != null ? { ... } : null` prevents accessing nested fields when parent is null
- ✅ No nested optional access - direct field reference within conditional block
- ✅ Validation prevents negative values

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.retryTime`)
- ✅ ForceNew handled (inherited from parent `soa_record` block in Task #5)
- ✅ Logic exactly replicated from provider (direct integer assignment)
- ✅ Validations implemented in variables.tf (IntAtLeast(0) replicated exactly)
- ✅ TODO comment: N/A (no sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md: N/A (no work deferred from this task)
- ✅ Deferred work from following.md: Checked, none deferred to this task
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof
- ✅ Proof created
- ✅ track.md will be updated to Pending for check
- ✅ Self-Review: Only implemented `retry_time` field as required by Task #10, no other fields added

## Critical Review

### Implementation Correctness
✅ **Exact Provider Behavior Replicated**:
- Default value (300) matches provider schema
- Validation (>= 0) matches provider validation
- Field placement in post-creation operation matches provider's two-phase create pattern
- Type conversion (number → int64) handled correctly by AzAPI provider 2.0+

### No Compromises or Simplifications
- ✅ Implementation uses exact provider validation logic
- ✅ No "more conservative" or "safer" alternatives used
- ✅ No simplifications or shortcuts taken
- ✅ Exact match to provider behavior with Go code evidence

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #10 - soa_record.retry_time

### Validation Results

✅ **Field Logic Completeness:** All provider logic identified and implemented
✅ **Default Value Implementation:** Correctly using `optional(number, 300)` per executor.md preferred method
✅ **Validation Implementation:** IntAtLeast(0) replicated exactly in variables.tf validation block
✅ **ForceNew Logic:** Inherited from parent soa_record block (Task #5), full value tracking implemented
✅ **Stable Keys:** All keys stable, no conditional key appearance/disappearance
✅ **Phase Detection:** Correctly placed in post_creation0 (CreateOrUpdate operation after primary create)
✅ **Type Conversion:** Correct conversion from Terraform number to Azure API Number type
✅ **Null Handling:** Safe parent null check prevents accessing nested fields when soa_record is null
✅ **Validations:** Provider validation IntAtLeast(0) implemented exactly in variables.tf
✅ **Sensitive Fields:** N/A - field is not sensitive or write-only
✅ **Shared Path Merge Check:** No duplicate parent keys, no shallow merge overwrites
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** N/A - no deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (null semantics, boundary conditions, idempotency, safe references)
✅ **Proof Document Quality:** No forbidden phrases, evidence-based, exact replication documented

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The default value implementation uses the preferred `optional(number, 300)` method at the nested level. The validation exactly matches the provider's IntAtLeast(0) constraint. The field is correctly placed in the post-creation operation (post_creation0) matching the provider's two-phase create pattern. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
