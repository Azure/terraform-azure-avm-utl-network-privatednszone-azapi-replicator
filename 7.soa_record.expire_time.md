# Task #7: soa_record.expire_time - Proof Document

## Summary
Implemented the `soa_record.expire_time` block argument for azurerm_private_dns_zone. The field is Optional with a default of 2419200 and maps to `post_creation0.body.properties.soaRecord.expireTime` in the SOA record creation operation.

## Shadow Implementation
```hcl
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type                 = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
      name                 = "@"
      parent_id            = null
      tags                 = null
      ignore_null_property = true
      retry                = null
    }
    body = {
      properties = {
        # ttl = ... # Task #11
        # metadata = ... # Task #12
        soaRecord = {
          email      = var.soa_record.email
          expireTime = var.soa_record.expire_time # <-
          # minimumTtl = ... # Task #8
          # refreshTime = ... # Task #9
          # retryTime = ... # Task #10
        }
      }
    }
    locks = local.locks
  } : null
}
```

## Create Phase Verification

### Query: Create Method
From `resourcePrivateDnsZoneCreateUpdate`:

```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).PrivateDns.PrivateZonesClient
	recordSetsClient := meta.(*clients.Client).PrivateDns.RecordSetsClient
	subscriptionId := meta.(*clients.Client).Account.SubscriptionId
	ctx, cancel := timeouts.ForCreateUpdate(meta.(*clients.Client).StopContext, d)
	defer cancel()

	id := privatezones.NewPrivateDnsZoneID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))
	
	// ... resource existence check ...
	
	parameters := privatezones.PrivateZone{
		Location: pointer.To("global"),
		Tags:     tags.Expand(d.Get("tags").(map[string]interface{})),
	}

	options := privatezones.CreateOrUpdateOperationOptions{
		IfMatch:     pointer.To(""),
		IfNoneMatch: pointer.To(""),
	}

	// PRIMARY ZONE CREATION
	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}

	// POST-CREATION SOA RECORD OPERATION
	if v, ok := d.GetOk("soa_record"); ok {
		soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
		soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
		rsParameters := privatedns.RecordSet{
			Properties: &privatedns.RecordSetProperties{
				Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
				Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
				SoaRecord: soaRecord,  // <- expire_time is in soaRecord
			},
		}

		recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

		createOptions := privatedns.RecordSetsCreateOrUpdateOperationOptions{
			IfMatch:     pointer.To(""),
			IfNoneMatch: pointer.To(""),
		}

		if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
			return fmt.Errorf("creating/updating %s: %s", recordId, err)
		}
	}
	// ...
}
```

### Pattern Identification
**Two-Phase Creation Pattern:**
1. **Primary Create:** `client.CreateOrUpdateThenPoll()` - creates the Private DNS Zone
2. **Post-Creation:** `recordSetsClient.RecordSetsCreateOrUpdate()` - creates/updates the SOA record

### Field Classification
The `expire_time` field is processed **AFTER** the primary Private DNS Zone creation, within the SOA record structure that's sent to a separate API call. This is a **post-creation operation**.

### Decision
The `expire_time` field belongs in `post_creation0.body.properties.soaRecord.expireTime` as documented in Task #5.

## Assignment Path Verification

### Predicted Path
`post_creation0.body.properties.soaRecord.expireTime`

### Go Code Evidence - Expand Function
From Task #5 documentation (in 5.soa_record.md):
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
	return &privatedns.SoaRecord{
		Email:       pointer.To(input["email"].(string)),
		ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
		MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
		RefreshTime: pointer.To(int64(input["refresh_time"].(int))),
		RetryTime:   pointer.To(int64(input["retry_time"].(int))),
	}
}
```

### Go Code Evidence - Assignment Path
From Create method:
```go
soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
		Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
		SoaRecord: soaRecord,  // <- Assigned here
	},
}
```

**Struct Assignment Tracing:**
1. `input["expire_time"].(int)` → converted to `int64` → `SoaRecord.ExpireTime` (in expand function)
2. `soaRecord` → `RecordSetProperties.SoaRecord` (in Create method)
3. `&privatedns.RecordSetProperties{...}` → `RecordSet.Properties`

### Verified Path
`body.properties.soaRecord.expireTime` (where `body` is the RecordSet resource)

### Path Comparison
- **Predicted:** `post_creation0.body.properties.soaRecord.expireTime`
- **Verified:** `body.properties.soaRecord.expireTime`
- **Match:** ✅ EXACT MATCH

## Provider Schema

### Source: azurerm_private_dns_zone
```go
"soa_record": {
	Type:     pluginsdk.TypeList,
	MaxItems: 1,
	Optional: true,
	Computed: true,
	ForceNew: true,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"expire_time": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      2419200,
				ValidateFunc: validation.IntAtLeast(0),
			},
			// ... other fields ...
		},
	},
},
```

### Key Properties
- **Type:** Int
- **Required:** No (Optional)
- **Default:** 2419200
- **ForceNew:** Yes (parent block is ForceNew)
- **Validation:** `validation.IntAtLeast(0)`
- **Sensitive:** No

## Azure API Schema

### Resource Type
`Microsoft.Network/privateDnsZones/SOA@2024-06-01`

### Property Path
`body.properties.soaRecord.expireTime`

### Type Information
From query result:
```
soaRecord: ObjectWithOptionalAttrs(map[string]Type{
    "email": String,
    "expireTime": Number,
    "host": String,
    "minimumTtl": Number,
    "refreshTime": Number,
    "retryTime": Number,
    "serialNumber": Number
}, []string{"email", "expireTime", "host", "minimumTtl", "refreshTime", "retryTime", "serialNumber"})
```

**Azure API Type:** Number (all SOA record fields are required in the Azure API schema)

## Hidden Fields
✅ **NO HIDDEN FIELDS** - The expand function directly maps the expire_time field without adding hidden fields.

## Mapping

### snake_case to camelCase
- Terraform: `expire_time`
- Azure API: `expireTime`
- Transformation: snake_case → camelCase

## Special Handling

### Default Value
The field has a default value of **2419200** in the provider schema.

**Implementation:** The default is already handled in `variables.tf` using the `optional()` syntax:
```hcl
variable "soa_record" {
  type = object({
    email        = string
    expire_time  = optional(number, 2419200)
    // ... other fields ...
  })
}
```

This ensures that if the user doesn't provide `expire_time`, the value defaults to `2419200`.

### Validation
The field has validation `IntAtLeast(0)` in the provider schema.

**Implementation:** The validation is already implemented in `variables.tf`:
```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.expire_time >= 0
  )
  error_message = "The `expire_time` must be at least 0."
}
```

This exactly replicates the provider's validation logic.

### Type Conversion
The provider converts the Terraform `int` to Go `int64` before sending to Azure API:
```go
ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
```

**Implementation:** Terraform's `number` type will be automatically converted to the appropriate numeric type by the AzAPI provider when sending to the Azure API. No explicit conversion needed in our implementation.

### ForceNew Handling
The parent block `soa_record` is marked as `ForceNew: true` in the provider schema. This is already handled in Task #5, where the entire `soa_record` variable is tracked in `replace_triggers_external_values`:

```hcl
replace_triggers_external_values = {
  soa_record = { value = var.soa_record }
}
```

Changes to `expire_time` will trigger replacement because the full `var.soa_record` object value is tracked. No additional ForceNew handling is needed for this field.

### Sensitive Fields
✅ **NOT SENSITIVE** - The expire_time field is not marked as Sensitive in the provider schema.

### Post-Creation Operation
✅ **Post-Creation Field** - This field is part of the `post_creation0` operation as identified in Task #5. The SOA record is created/updated AFTER the primary Private DNS Zone creation.

## Deferred Work Completion
Checked for `following.md` - file does not exist. No deferred work for Task #7.

## Critical Review & Edge Case Analysis

### Null Semantics
- **When `var.soa_record == null`:** The entire `post_creation0` block is `null`, so no SOA record update occurs
- **When `var.soa_record != null` and `expire_time` not provided:** Defaults to `2419200` (handled by `optional(number, 2419200)` in variable type)
- **When `var.soa_record != null` and `expire_time = 0`:** Valid value (minimum is 0)
- **Meaning:** The default is "use standard expire time of 2419200 seconds (28 days)"

### Edge Cases

**Zero Value:**
✅ `expire_time = 0` is VALID per validation (`IntAtLeast(0)`). Zero means "never expire" in DNS semantics, though unusual for SOA records.

**Negative Values:**
✅ Blocked by validation - minimum is 0.

**Maximum Value:**
✅ No explicit maximum in provider schema. Terraform `number` type can represent very large integers. Azure API uses `Number` type which should handle standard SOA expire times (typically up to several weeks in seconds).

**Default vs Explicit:**
✅ Default `2419200` is applied at variable level via `optional(number, 2419200)`, ensuring consistent behavior whether user omits the field or explicitly sets it to `2419200`.

**Type Safety:**
✅ Terraform type system ensures only numeric values are accepted. Provider converts to `int64` for API call. AzAPI provider will handle the conversion from Terraform number to JSON number.

### Idempotency
✅ **IDEMPOTENT** - Direct numeric value assignment with no transformation logic. Same input produces same output.
- Default value is consistently applied
- No order-dependent operations
- No random or time-based values

### Safe References
✅ **SAFE** - Field is accessed via `var.soa_record.expire_time` only when `var.soa_record != null` is already checked in the conditional:
```hcl
post_creation0 = var.soa_record != null ? {
  // ... expire_time accessed here safely
} : null
```

The `optional()` syntax in the variable definition ensures `expire_time` always has a value when the parent object exists.

### Boundary Conditions

**Minimum Boundary (0):**
- Valid per validation
- Unusual but technically valid in DNS
- Azure API should accept it

**Typical Values:**
- Default: 2419200 seconds (28 days)
- Common range: 1 week to 4 weeks (604800 to 2419200 seconds)

**Large Values:**
- No explicit maximum in provider
- Terraform number type and Azure API Number type should handle typical SOA expire times
- SOA expire times rarely exceed a few months (several million seconds)

### Azure API Behavior
According to the Azure API schema, `expireTime` is a required field in the `soaRecord` object. Our implementation ensures this field always has a value:
- If user provides it: use their value
- If user omits it: use default 2419200
- Field cannot be null when `soa_record` block is set

### Comparison with Provider Logic
The provider implementation:
```go
ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
```

Our implementation:
```hcl
expireTime = var.soa_record.expire_time
```

Both implementations:
- ✅ Take the numeric value from the variable/input
- ✅ Apply default at schema/variable level (not in expand logic)
- ✅ Send to Azure API as a number
- ✅ No special transformation or conditional logic

**Result:** ✅ EXACT match in behavior

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.expireTime`)
- ✅ ForceNew wrapped (parent block tracked: `soa_record = { value = var.soa_record }`)
- ✅ ALL logic EXACTLY replicated from provider (direct numeric mapping with default)
- ✅ Validations IMPLEMENTED in variables.tf (MANDATORY - IntAtLeast(0))
- ✅ TODO comment N/A (not a sensitive field migration)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work in following.md (N/A - no deferral needed)
- ✅ Deferred work from following.md (file doesn't exist)
- ✅ Critical review (null, edge, idempotent, safe refs) completed
- ✅ Edge Case Analysis in proof (included above)
- ✅ Proof created
- ✅ track.md to be updated to Pending for check
- ✅ Self-Review: Only implementing soa_record.expire_time field as specified in Task #7

## Implementation Files Changed

### Modified Files
1. `migrate_main.tf` - Added `expireTime = var.soa_record.expire_time` to `post_creation0.body.properties.soaRecord`

### No New Files
No new files created - implementation uses existing variable definition from `variables.tf` with default already configured.

## Notes

1. **Default Handling:** The default value `2419200` is applied via `optional(number, 2419200)` in the variable type definition, matching provider behavior
2. **Type Conversion:** Terraform number → Azure API Number happens automatically via AzAPI provider
3. **Validation:** `IntAtLeast(0)` validation already implemented in `variables.tf`
4. **ForceNew:** Inherited from parent block tracking in Task #5
5. **No CustomizeDiff:** Resource function has no CustomizeDiff logic
6. **Post-Creation:** Part of SOA record creation after primary zone creation

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #7 - soa_record.expire_time

### Validation Results

✅ **Field Logic Completeness:** All locations queried (resource function, Create method, expand function)
✅ **Provider Schema Analysis:** Correctly identified as Optional with Default=2419200, validation IntAtLeast(0), ForceNew inherited from parent
✅ **Azure API Schema:** Correct path `properties.soaRecord.expireTime`, type Number
✅ **Assignment Path:** Verified path matches prediction - `post_creation0.body.properties.soaRecord.expireTime`
✅ **Phase Detection:** Correctly identified as post-creation operation (Phase 2 after primary zone creation)
✅ **Type Conversion:** Terraform number → Azure API Number, no explicit conversion needed
✅ **Null Handling:** Safely accessed via parent conditional `var.soa_record != null`
✅ **Default Value:** Correctly uses `optional(number, 2419200)` in variable type - EXACT match to provider
✅ **Validation:** IntAtLeast(0) validation implemented in variables.tf validation block - EXACT match to provider
✅ **ForceNew Logic:** Inherited from parent block tracking in Task #5 (`soa_record = { value = var.soa_record }`) - tracks FULL value, not just presence
✅ **Stable Keys:** Parent block tracked in replace_triggers_external_values with stable key
✅ **Sensitive Fields:** Not sensitive - correctly placed in body, not sensitive_body
✅ **Deferred Work Completion:** No deferred work (following.md doesn't exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Comprehensive analysis - zero value, negative values blocked, default vs explicit, idempotency
✅ **Critical Review:** Null semantics, boundary conditions, safe references all verified
✅ **Implementation Scope:** ONLY Task #7 field implemented, no scope creep

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`:
- Direct field mapping with no transformation (matches provider's `ExpireTime: pointer.To(int64(input["expire_time"].(int)))`)
- Default value applied via `optional(number, 2419200)` at variable level (matches provider schema `Default: 2419200`)
- Validation `IntAtLeast(0)` replicated in variables.tf (matches provider `ValidateFunc: validation.IntAtLeast(0)`)
- ForceNew inherited from parent block (matches provider schema `ForceNew: true` on parent)
- Correct post-creation placement (matches provider's two-phase creation pattern)
- No deviations, simplifications, or "safer alternatives" found

**Status:** APPROVED ✅

---
