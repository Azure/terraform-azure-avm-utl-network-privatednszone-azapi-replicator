# Task #12 - soa_record.tags - Implementation Proof

## Shadow Implementation

```hcl
# In migrate_main.tf
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type                 = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
      name                 = "@"
      parent_id            = null
      tags                 = null
      ignore_null_property = true
      retry                = null
    }
    body = {
      properties = {
        ttl      = var.soa_record.ttl
        metadata = var.soa_record.tags # <-
        soaRecord = {
          email       = var.soa_record.email
          expireTime  = var.soa_record.expire_time
          minimumTtl  = var.soa_record.minimum_ttl
          refreshTime = var.soa_record.refresh_time
          retryTime   = var.soa_record.retry_time
        }
      }
    }
    locks = local.locks
  } : null
}
```

## Summary

Implemented `soa_record.tags` as `metadata` in the SOA record's POST-creation operation. The field is optional and maps directly from the Terraform variable to Azure API's metadata property.

## Create Phase Verification

**Query Results:**

From `resourcePrivateDnsZoneCreateUpdate` function:

```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).PrivateDns.PrivateZonesClient
	recordSetsClient := meta.(*clients.Client).PrivateDns.RecordSetsClient
	// ...

	// PRIMARY PHASE: Create Private DNS Zone
	parameters := privatezones.PrivateZone{
		Location: pointer.To("global"),
		Tags:     tags.Expand(d.Get("tags").(map[string]interface{})),
	}

	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}

	// POST-CREATION PHASE: Update SOA record
	if v, ok := d.GetOk("soa_record"); ok {
		soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
		soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
		rsParameters := privatedns.RecordSet{
			Properties: &privatedns.RecordSetProperties{
				Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
				Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})), // <-- Here
				SoaRecord: soaRecord,
			},
		}

		recordId := privatedns.NewRecordTypeID(id.SubscriptionId, id.ResourceGroupName, id.PrivateDnsZoneName, privatedns.RecordTypeSOA, "@")

		if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
			return fmt.Errorf("creating/updating %s: %s", recordId, err)
		}
	}
	// ...
}
```

**Pattern Identification:**

This is a **two-phase creation pattern**:
1. **Primary phase**: `client.CreateOrUpdateThenPoll()` - creates the Private DNS Zone
2. **Post-creation phase**: `recordSetsClient.RecordSetsCreateOrUpdate()` - updates SOA record via a separate API call

**Field Classification:**

The `tags` field is processed in the **post-creation phase** using the `RecordSetsCreateOrUpdate` SDK function. This maps to `post_creation0` as identified in Task #4 (Type 2 task that established the post-creation pattern).

**SDK Function Type:** `CreateOrUpdate` → `post_creation0`

**Decision:** Field belongs in `local.post_creation0.body.properties.metadata` (not in primary `local.body`).

## Assignment Path Verification

**Predicted Path:** `properties.metadata`

**Go Code Evidence:**

```go
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
		// ...
	},
}
```

**Path Tracing:**
1. `rsParameters` is of type `privatedns.RecordSet`
2. `RecordSet.Properties` → adds `properties` nesting
3. `RecordSetProperties.Metadata` → field name is `Metadata`
4. Azure API converts Go field `Metadata` to JSON field `metadata`

**Verified Path:** `properties.metadata` ✅

**Path Comparison:** Predicted path matches verified path ✅

## Provider Schema

From `resourcePrivateDnsZone()` schema definition:

```go
"soa_record": {
	Type:     pluginsdk.TypeList,
	MaxItems: 1,
	Optional: true,
	Computed: true,
	ForceNew: true,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			// ... other fields ...
			"tags": commonschema.Tags(),
			// ... other fields ...
		},
	},
},
```

**Field Properties:**
- **Name**: `tags`
- **Type**: Map of strings (from `commonschema.Tags()`)
- **Required**: No (Optional)
- **Default**: None
- **ForceNew**: Yes (inherited from parent `soa_record` block)
- **Validation**: None (standard tags field)
- **Computed**: No
- **Sensitive**: No

## Azure API Schema

**Resource Type:** `Microsoft.Network/privateDnsZones/SOA@2024-06-01`

**Schema Query Result:**
```
"metadata": Map(String)
```

**API Property Path:** `properties.metadata`

**API Field Properties:**
- **Type**: Map(String) - a dictionary/map of string key-value pairs
- **Required**: No (optional)
- **Description**: Key-value pairs for metadata associated with the record set

## Hidden Fields

**Check:** None. The `tags` field is explicitly declared in the provider schema and has no hidden fields or hardcoded values.

## Mapping

**Provider Schema → Azure API:**
- Provider field: `soa_record.tags` (snake_case)
- Azure API field: `properties.metadata` (camelCase)
- Type conversion: Direct mapping via `tags.Expand()` helper

**Key Insight:** While the provider exposes this as `tags`, the Azure API calls it `metadata`. This is consistent with DNS record sets having metadata separate from resource-level tags.

## Special Handling

### 1. ForceNew Behavior

**Schema:** `soa_record` block has `ForceNew: true`

**Analysis:** The `tags` field inherits ForceNew from its parent `soa_record` block. Any change to the entire `soa_record` block triggers recreation, including changes to just the `tags` field.

**Implementation:** Already handled in `replace_triggers_external_values`:

```hcl
replace_triggers_external_values = {
  soa_record = { value = var.soa_record }
}
```

This tracks the ENTIRE `soa_record` object (including `tags`), so any change to `tags` will trigger resource replacement. No additional ForceNew handling needed for this specific field.

### 2. Validation

**Schema Check:** No validation functions applied to `tags` field (standard `commonschema.Tags()` has no validators).

**Implementation:** No custom validation needed. The field already has `optional(map(string))` type constraint in `variables.tf` which provides sufficient type checking.

### 3. Sensitive Fields

**Check:** Not sensitive. Tags are metadata and not marked as Sensitive in the schema.

**Implementation:** Field remains in `body`, not moved to `sensitive_body`.

### 4. Post-Creation Operation

**Classification:** This field is part of the `post_creation0` operation (SOA record update after zone creation).

**Implementation:** Added to `local.post_creation0.body.properties.metadata` as established by the Create phase verification above.

## Deferred Work Completion

**Check:** Reviewed `following.md` - file does not exist yet, indicating no work has been deferred to this task.

**Status:** No deferred work to complete. ✅

## Critical Review & Edge Case Analysis

### Null Semantics

**Question:** What does `null` mean for `tags`?

**Answer:** When `var.soa_record.tags` is `null`:
- The `metadata` field is set to `null` in the API body
- AzAPI with `ignore_null_property = true` omits null fields from the request
- Azure API treats this as "no metadata" (uses default: no metadata)
- This is correct behavior per Azure API specification

### Edge Cases

1. **Empty map (`{}`)**: 
   - Provider accepts empty map
   - Azure API accepts empty metadata object
   - Result: SOA record has no metadata tags
   - ✅ Handled correctly (empty map is sent, not omitted)

2. **Null vs Unset**:
   - Variable default: `optional(map(string))` defaults to `null` when not provided
   - When `null`: field is omitted from API request (AzAPI `ignore_null_property = true`)
   - ✅ Correct behavior matches provider

3. **Tag key/value constraints**:
   - Azure tag keys: max 512 chars, cannot contain `<`, `>`, `%`, `&`, `\`, `?`, `/`
   - Azure tag values: max 256 chars
   - Provider uses standard `commonschema.Tags()` which handles Azure tag validation
   - Our implementation: Type constraint `map(string)` provides basic validation
   - ✅ Azure API will validate constraints; type system provides basic safety

### Idempotency

**Question:** Is the implementation idempotent?

**Analysis:**
- Tags are applied directly: `metadata = var.soa_record.tags`
- No order-dependent operations
- Map structure preserves key-value pairs consistently
- Re-applying the same tags produces identical API calls

**Result:** ✅ Idempotent

### Safe References

**Question:** Are all references null-safe?

**Analysis:**
```hcl
post_creation0 = var.soa_record != null ? {
  body = {
    properties = {
      metadata = var.soa_record.tags  # Safe: only accessed when var.soa_record != null
    }
  }
} : null
```

The `var.soa_record.tags` reference is only accessed when `var.soa_record != null`, making it safe. Even when `tags` itself is `null`, it's a valid value to pass to the API.

**Result:** ✅ All references are safe

## Completion Checklist

- ✅ Property in correct local (`post_creation0.body.properties.metadata`)
- ✅ ForceNew already wrapped in parent block tracking
- ✅ ALL logic EXACTLY replicated from provider (simple direct mapping via `tags.Expand()`)
- ✅ Validations: None required (standard tags field, type constraint sufficient)
- ✅ TODO comment: N/A (not a sensitive field requiring independent variable)
- ✅ Hidden fields checked: None found
- ✅ Deferred work recorded: N/A (no cross-field dependencies)
- ✅ Deferred work completed: Checked `following.md` (doesn't exist, no deferred work)
- ✅ Critical review completed (null, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis section added
- ✅ Proof created
- ✅ `track.md` will be updated to "Pending for check"
- ✅ Self-Review: Only implemented `soa_record.tags` field, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #12 - soa_record.tags

### Validation Results

✅ **ForceNew Logic:** Correctly inherited from parent `soa_record` block with `ForceNew: true`. Full value tracking implemented via `soa_record = { value = var.soa_record }` which correctly detects changes to tags field.

✅ **Stable Keys:** Key `soa_record` always present in `replace_triggers_external_values` with stable structure.

✅ **Phase Detection:** Field correctly placed in `local.post_creation0.body.properties.metadata` for post-creation SOA record update operation.

✅ **Type Conversion:** Correct direct mapping from Terraform `optional(map(string))` to Azure API `Map(String)` via `properties.metadata`.

✅ **Null Handling:** Correctly propagates null semantics - null values omitted via `ignore_null_property = true`, empty map `{}` sent as empty metadata object.

✅ **Validations:** None required for standard tags field. Type constraint `optional(map(string))` provides sufficient validation.

✅ **Deferred Work Completion:** No deferred work for this task (verified `following.md` does not exist).

✅ **Deferred Work Recording:** No deferrals made (no cross-field dependencies).

✅ **Edge Cases:** All edge cases properly analyzed and handled:
  - Empty map behavior verified
  - Null vs unset semantics correct
  - Idempotency confirmed
  - Safe reference patterns validated

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field is correctly mapped from `soa_record.tags` to Azure API `properties.metadata` in the post-creation SOA record update operation. ForceNew behavior is inherited from the parent block and tracked via full value comparison. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
