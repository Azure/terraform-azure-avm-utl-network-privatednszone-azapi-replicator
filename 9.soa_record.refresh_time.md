# Task #9 - soa_record.refresh_time - Proof Document

## Summary

Implemented `soa_record.refresh_time` field in `local.post_creation0.body.properties.soaRecord.refreshTime`. The field is Optional with default value 3600 and must be at least 0. The provider converts it to int64 and assigns directly to the SOA record.

## Shadow Implementation

```hcl
locals {
  post_creation0 = var.soa_record != null ? {
    azapi_header = {
      type                 = "Microsoft.Network/privateDnsZones/SOA@2024-06-01"
      name                 = "@"
      parent_id            = null
      tags                 = null
      ignore_null_property = true
      retry                = null
    }
    body = {
      properties = {
        soaRecord = {
          email       = var.soa_record.email
          expireTime  = var.soa_record.expire_time
          minimumTtl  = var.soa_record.minimum_ttl
          refreshTime = var.soa_record.refresh_time # <- Task #9
        }
      }
    }
    locks = local.locks
  } : null
}
```

## Create Phase Verification

**Pattern**: Two-phase creation
- **Phase 1**: Main zone creation via `client.CreateOrUpdateThenPoll(ctx, id, parameters, options)`
- **Phase 2**: SOA record update via `recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions)`

**Evidence from Create method**:
```go
func resourcePrivateDnsZoneCreateUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	// Phase 1: Create zone
	if err := client.CreateOrUpdateThenPoll(ctx, id, parameters, options); err != nil {
		return fmt.Errorf("creating/updating %s: %s", id, err)
	}

	// Phase 2: Update SOA record (if soa_record block provided)
	if v, ok := d.GetOk("soa_record"); ok {
		soaRecordRaw := v.([]interface{})[0].(map[string]interface{})
		soaRecord := expandPrivateDNSZoneSOARecord(soaRecordRaw)
		rsParameters := privatedns.RecordSet{
			Properties: &privatedns.RecordSetProperties{
				Ttl:       pointer.To(int64(soaRecordRaw["ttl"].(int))),
				Metadata:  tags.Expand(soaRecordRaw["tags"].(map[string]interface{})),
				SoaRecord: soaRecord, // <- refresh_time is inside this
			},
		}
		// ...
		if _, err := recordSetsClient.RecordSetsCreateOrUpdate(ctx, recordId, rsParameters, createOptions); err != nil {
			return fmt.Errorf("creating/updating %s: %s", recordId, err)
		}
	}
	// ...
}
```

**Field Classification**: `refresh_time` is processed in Phase 2 (post-creation SOA record update), therefore it belongs to `local.post_creation0`.

**SDK Function**: `RecordSetsCreateOrUpdate` (CreateOrUpdate operation) → `post_creation0`

## Assignment Path Verification

**Predicted Path**: `properties.soaRecord.refreshTime`

**Go Code Evidence**:
```go
func expandPrivateDNSZoneSOARecord(input map[string]interface{}) *privatedns.SoaRecord {
	return &privatedns.SoaRecord{
		Email:       pointer.To(input["email"].(string)),
		ExpireTime:  pointer.To(int64(input["expire_time"].(int))),
		MinimumTtl:  pointer.To(int64(input["minimum_ttl"].(int))),
		RefreshTime: pointer.To(int64(input["refresh_time"].(int))), // <- Direct assignment
		RetryTime:   pointer.To(int64(input["retry_time"].(int))),
	}
}
```

From Create method:
```go
rsParameters := privatedns.RecordSet{
	Properties: &privatedns.RecordSetProperties{
		// ...
		SoaRecord: soaRecord, // <- soaRecord struct assigned to Properties.SoaRecord
	},
}
```

**Traced Path**:
1. `input["refresh_time"]` → field extracted
2. Type converted to `int64`
3. Wrapped with `pointer.To()`
4. Assigned to `SoaRecord.RefreshTime` field
5. SoaRecord assigned to `RecordSetProperties.SoaRecord`
6. RecordSetProperties assigned to `RecordSet.Properties`

**Verified Path**: `properties.soaRecord.refreshTime`

**Path Comparison**: ✅ Match - predicted path matches actual API structure

## Provider Schema

From `resourcePrivateDnsZone()` schema definition:

```go
"soa_record": {
	Type:     pluginsdk.TypeList,
	MaxItems: 1,
	Optional: true,
	Computed: true,
	ForceNew: true,
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			// ...
			"refresh_time": {
				Type:         pluginsdk.TypeInt,
				Optional:     true,
				Default:      3600,
				ValidateFunc: validation.IntAtLeast(0),
			},
			// ...
		},
	},
},
```

**Schema Properties**:
- **Type**: TypeInt
- **Optional**: true
- **Default**: 3600
- **ValidateFunc**: IntAtLeast(0)
- **ForceNew**: Inherited from parent block (soa_record has ForceNew: true)

## Azure API Schema

**Resource Type**: `Microsoft.Network/privateDnsZones/SOA@2024-06-01`

**Field Path**: `body.properties.soaRecord.refreshTime`

**Go Type from Schema Query**:
```
soaRecord:ObjectWithOptionalAttrs(map[string]Type{
  "email":String, 
  "expireTime":Number, 
  "host":String, 
  "minimumTtl":Number, 
  "refreshTime":Number,  // <- Our field
  "retryTime":Number, 
  "serialNumber":Number
}, ...)
```

**Type**: Number

**Documentation**: "The refresh value for this SOA record."

## Hidden Fields

None. The field is straightforward with no hidden logic.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| refresh_time          | refreshTime          |

## Special Handling

### Validation

The validation is already implemented in `variables.tf` at lines 81-85:

```hcl
validation {
  condition = var.soa_record == null || (
    var.soa_record.refresh_time >= 0
  )
  error_message = "The `refresh_time` must be at least 0."
}
```

This replicates the provider's `validation.IntAtLeast(0)` constraint.

### Default Value

The default value 3600 is already implemented in `variables.tf` at line 35:

```hcl
refresh_time = optional(number, 3600)
```

This replicates the provider's `Default: 3600` setting.

### ForceNew Behavior

The parent `soa_record` block has `ForceNew: true`, which means any change to the SOA record block (including refresh_time) forces recreation. This is already handled in `local.replace_triggers_external_values`:

```hcl
replace_triggers_external_values = {
  soa_record = { value = var.soa_record }
}
```

Since we track the full `var.soa_record` object, changes to `refresh_time` will be detected and trigger replacement as required.

### Sensitive Fields

Not applicable - refresh_time is not sensitive.

### Post-Creation Operation

The field is part of `post_creation0` because the SOA record is updated via a separate API call after the main zone is created. The field is placed in the correct location within the post_creation0 structure.

## Deferred Work Completion

No work was deferred to this task (following.md does not exist).

## Critical Review & Edge Case Analysis

### Null Semantics
- **Variable level**: Field is optional with default 3600. If user doesn't specify, it defaults to 3600.
- **Azure API**: The field is required in the API payload. Since we use the default value, it will always have a value when SOA record is configured.

### Boundary Conditions
- **Minimum**: 0 (validated)
- **Maximum**: No explicit upper bound in provider, but Azure API accepts Number type (int64 range)
- **Default**: 3600 seconds (1 hour)

### Edge Cases
1. **Zero value**: `refresh_time = 0` is valid and passes validation
2. **Large values**: Provider uses int type, Azure API uses int64. Type conversion in expand function handles this correctly
3. **Null parent block**: If `var.soa_record == null`, the entire post_creation0 is null, so refresh_time is not sent to API

### Idempotency
The field value is directly assigned without any transformations that could affect idempotency. Subsequent applies with the same value will not cause changes.

### Safe References
The field is accessed via `var.soa_record.refresh_time` only when `var.soa_record != null` (guarded by the post_creation0 conditional), ensuring safe access.

### Type Conversion
Provider converts from Terraform int to Go int64 via type assertion and cast: `int64(input["refresh_time"].(int))`. Our implementation uses the number type which Azure API accepts directly as Number.

## Checklist

- ✅ Property in correct local (`post_creation0.body.properties.soaRecord.refreshTime`)
- ✅ ForceNew: Not directly applicable (handled at parent block level via `soa_record` trigger)
- ✅ All logic EXACTLY replicated from provider (simple direct assignment)
- ✅ Validations IMPLEMENTED in variables.tf (IntAtLeast(0) already present)
- ✅ TODO comment: Not applicable (not a sensitive field)
- ✅ Hidden fields checked: None
- ✅ Deferred work in following.md: Not applicable (no work deferred)
- ✅ Deferred work from following.md: None (file doesn't exist)
- ✅ Critical review completed
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Track.md ready to update to "Pending for check"
- ✅ Self-Review: Only refresh_time implementation added, no other fields touched

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2025-12-24
**Task:** #9 - soa_record.refresh_time

### Validation Results

✅ **ForceNew Logic:** Field is part of `soa_record` block which has `ForceNew: true`. Parent block tracking correctly implemented via `soa_record = { value = var.soa_record }` in replace_triggers_external_values, which tracks full object value (not just presence), properly detecting changes to refresh_time.

✅ **Stable Keys:** All keys in `replace_triggers_external_values` are stable (soa_record key always present).

✅ **Phase Detection:** Field correctly placed in `post_creation0.body.properties.soaRecord.refreshTime` (SOA record update occurs after main zone creation via separate RecordSetsCreateOrUpdate API call).

✅ **Type Conversion:** Correct conversion from Terraform number to Azure API Number type. Provider converts int to int64; Azure API accepts Number directly.

✅ **Null Handling:** Correctly propagates null semantics - when `var.soa_record == null`, entire post_creation0 is null. When soa_record is set, refresh_time uses default 3600.

✅ **Validations:** Provider validation `validation.IntAtLeast(0)` correctly replicated in variables.tf lines 81-85.

✅ **Default Values:** Provider default value 3600 correctly implemented using `optional(number, 3600)` syntax (preferred method per executor.md line 148).

✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist).

✅ **Deferred Work Recording:** No deferrals made by this task.

✅ **Edge Cases:** All edge cases properly analyzed (zero value valid, large values handled, null parent block guarded, idempotency preserved).

✅ **Method Priority Compliance:** Used preferred `optional(number, 3600)` for default value instead of fallback coalesce() method.

✅ **Assignment Path:** Correctly traced through expand function to verify path: properties.soaRecord.refreshTime.

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The field uses:
- Correct post-creation phase placement (post_creation0)
- Correct Azure API path (properties.soaRecord.refreshTime)
- Exact validation replication (IntAtLeast(0))
- Preferred default value method (optional() modifier)
- Proper ForceNew inheritance from parent block
- Safe null handling with conditional post_creation0

No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
